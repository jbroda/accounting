function selectReport(c){var b=String(c);var d=b.substring(b.indexOf("#"));var a=d+"_panel";console.log("selectForm(): showing "+a);$(a).collapse("show")}function onDeleteReport(c){console.log("Deleting report ...");try{var e=c.attr("action");var d=$("input[name=redirect_url]",c.context).val();console.log("Deleting: "+e+", redirect: "+d);$("#report_delete_btn",c.context).prop("disabled",true);$("#report_link",c.context).first().removeAttr("href");var a=$.ajax({type:"POST",url:e,data:{redirect_url:d},});a.done(function(f){console.log("deleteRq done ");c.parent().hide()});a.fail(function(g,f){console.log("deleteRq fail "+f)});a.always(function(){console.log("deleteRq always")})}catch(b){console.log(b.message)}return false}function getReportLink(d,c,e,b){var a="";a+='<form style="display: inline;"';a+='      name="report_delete_form"';a+='      id="report_delete_form"';a+='      action="/delete'+e+'"';a+='      onsubmit="return onDeleteReport($(this));"';a+='      method="post">';a+="";a+='    <a id="report_link" target="_blank" href="'+c+'">'+b+"</a>";a+="";a+='    <input type="hidden" ';a+='           name="redirect_url" ';a+='           id="redirect_url"';a+='           value="/accounting/reports/#'+d+'"/>';a+="";a+='    <button name="report_delete_btn"';a+='            id="report_delete_btn" ';a+='            type="submit" ';a+='            class="btn btn-danger btn-xs" ';a+="            title=\"Delete '"+b+"'\">";a+='        <span class="glyphicon glyphicon-remove"></span>';a+="    </button>";a+="</form>";a+="";return a}function get_report_list(b){console.log("get_report_list("+b+")");try{var a=$.ajax({type:"GET",dataType:"json",cache:false,url:"/accounting/reports/list/"+b+"/",report_type:b});a.done(function(k){console.log("listReportsRq done: "+k);var h=this.report_type;var e=k[h];var d="";for(i=0;i<e.length;i++){var g=e[i].name;var l=e[i].path;var f=e[i].url;console.log(h+" name: "+g+", path: "+l+", url: "+f);var j=getReportLink(h,f,l,g);d+="<li>"+j+"</li>"}if(0==e.length){d="<li>No "+h+" reports found!</li>"}$("#"+h+"_report_list").html(d)});a.fail(function(e,d){console.log("listReportsRq fail "+d)});a.always(function(){console.log("listReportsRq always")})}catch(c){console.log(c.message)}}$(document).ready(function(){var q=["transaction","statement","delinquency","income","account_trail","account_audit","lease","expired_lease","vos_lease","fha_lease","export"];for(var n in q){var p=q[n];var r="#"+p+"_panel";if($(r).length){$(r).collapse({toggle:false});$(r).on("shown.bs.collapse",(function(u){return function(){$(location).attr("hash",u)}})(p))}var o="#"+p+"_history";if($(o).length){$(o).on("show.bs.collapse",(function(u){return function(){console.log("show "+u+" history ...");$("#"+u+"_report_list").html("<li>Please wait ...</li>")}})(p));$(o).on("shown.bs.collapse",(function(u){return function(){console.log("shown "+u+" history ...");get_report_list(u)}})(p))}}var c=$(location).attr("hash");if(c!=""){var m=c+"_panel";console.log("ready(): showing "+m);$(m).collapse("show")}$("#dtpicker").datetimepicker({pickTime:false});$("#dtpicker_trans_start").datetimepicker({pickTime:false});$("#dtpicker_trans_end").datetimepicker({pickTime:false});$("#dtpicker_statement").datetimepicker({pickTime:false});$("#dtpicker_income_start").datetimepicker({pickTime:false});$("#dtpicker_income_end").datetimepicker({pickTime:false});$("#dtpicker_account_trail").datetimepicker({pickTime:false});$("#dtpicker_account_audit_start").datetimepicker({pickTime:false});$("#dtpicker_account_audit_end").datetimepicker({pickTime:false});$("#dtpicker_lease").datetimepicker({pickTime:false});$(".btn-group button").click(function(){$(this).parent().children().removeClass("active");$(this).addClass("active")});function s(v,u){v=v.toString();return v.length<u?s("0"+v,u):v}function l(u){return u.charAt(0).toUpperCase()+u.substring(1)}function g(u){var v=u.substring(u.lastIndexOf("/")+1);return v}function t(w,x,u,B,A){if(B&&A){console.log("Requesting PDF for the "+x+" report for "+B+" through "+A+"...")}else{if(B){console.log("Requesting PDF for the "+x+" report as of "+B+" ...")}else{console.log("Requesting PDF for the "+x+" report ...")}}w.prop("disabled",true);var v="."+x+"-progress ";$(v).show();$(v+"#progress").show();$(v+"#status").text("Generating the "+x+" report. Please wait ...");var z=getUUID();var y=$.ajax({type:"GET",dataType:"json",url:"/accounting/report/"+x+"/"+z+"/"+(u?(u+"/"):"")+(B?(B+"/"):"")+(A?(A+"/"):""),});$(v+"#cancel_report").off("click");$(v+"#cancel_report").on("click",function(){console.log('Cancel for "'+x+'" report request "'+z+'" pressed!');var C=$.ajax({type:"POST",url:"/accounting/report/cancel/"+x+"/"+z+"/",});C.done(function(D){console.log("cancelRq done "+D)});C.fail(function(E,D){console.log("cancelRq fail "+D)});C.always(function(){console.log("cancelRq always")});y.abort()});y.done(function(C){url=C.url;path=C.path;console.log("Received "+x+" report PDF URL: "+url+", PATH: "+path);$(v+"#report").show();$(v+"#report_heading").show();$(v+"#report_link").attr("href",url);$(v+"#report_link").text("Your "+l(x)+" Report");$(v+"#report_delete_form").attr("action","/delete"+path);$(v+"#redirect_url").val("/accounting/reports/#"+x);$(v+"#report_delete_btn").attr("title","Delete '"+g(url)+"'");var D=window.open(url,"_blank");popupBlockerChecker.check(D)});y.fail(function(C,D){console.log("failure: "+D);$(v).hide();if(D=="abort"){alert('"'+x+'" report canceled.')}else{alert('Failed to generate the "'+x+'" report: '+D+"!")}});y.always(function(){console.log('Request for "'+x+'" report complete!');$(v+"#progress").hide();w.prop("disabled",false)})}function f(){var v=new Date($("#delinq_date").val());var u=""+v.getFullYear()+"-"+s(v.getMonth()+1,2)+"-"+s(v.getDate(),2);console.log("requesting delinquency report for "+u+" ...");t($("#get_d_report"),"delinquency",u)}function d(){var x=new Date($("#transaction_bdate").val());var w=""+x.getFullYear()+"-"+s(x.getMonth()+1,2)+"-"+s(x.getDate(),2);x=new Date($("#transaction_edate").val());var v=""+x.getFullYear()+"-"+s(x.getMonth()+1,2)+"-"+s(x.getDate(),2);var u="0";if($("#charges").hasClass("active")){u="1"}else{if($("#alltransactions").hasClass("active")){u="2"}}t($("#get_t_report"),"transaction",u,w,v)}function a(){var v=new Date($("#statement_date").val());var u=""+v.getFullYear()+"-"+s(v.getMonth()+1,2)+"-"+s(v.getDate(),2);t($("#get_s_report"),"statement",u)}function k(){var x=new Date($("#income_bdate").val());var w=""+x.getFullYear()+"-"+s(x.getMonth()+1,2)+"-"+s(x.getDate(),2);x=new Date($("#income_edate").val());var v=""+x.getFullYear()+"-"+s(x.getMonth()+1,2)+"-"+s(x.getDate(),2);var u="0";if($("#accrual").hasClass("active")){u="1"}t($("#get_i_report"),"income",u,w,v)}function j(){var v=new Date($("#account_trail_date").val());var u=""+v.getFullYear()+"-"+s(v.getMonth()+1,2)+"-"+s(v.getDate(),2);t($("#get_at_report"),"account_trail",u)}function e(){var w=new Date($("#account_audit_bdate").val());var v=""+w.getFullYear()+"-"+s(w.getMonth()+1,2)+"-"+s(w.getDate(),2);w=new Date($("#account_audit_edate").val());var u=""+w.getFullYear()+"-"+s(w.getMonth()+1,2)+"-"+s(w.getDate(),2);t($("#get_account_audit_report"),"account_audit_report",v,u)}function b(){var w=new Date($("#lease_date").val());var u=""+w.getFullYear()+"-"+s(w.getMonth()+1,2)+"-"+s(w.getDate(),2);var v="expired";if($("#fha").hasClass("active")){v="fha"}else{if($("#vos").hasClass("active")){v="vos"}}t($("#get_l_report"),"lease",v,u)}function h(){console.log("requesting export report ...");t($("#get_exp_report"),"export","")}$.validator.setDefaults({highlight:function(u){$(u).closest(".form-group").addClass("has-error")},unhighlight:function(u){$(u).closest(".form-group").removeClass("has-error")},errorElement:"span",errorClass:"help-block",errorPlacement:function(u,v){if(v.parent(".input-group").length){u.insertAfter(v.parent())}else{u.insertAfter(v)}}});$.validator.addMethod("validDate",function(x,v){var u=x;var w=!/Invalid|NaN/.test(new Date(u).toString());return this.optional(v)||(w)},"Please enter a valid date.");$("#delinq-report-form").validate({submitHandler:function(){f()},rules:{delinq_date:{validDate:true,required:true}}});$("#transaction-report-form").validate({submitHandler:function(){d()},rules:{transaction_bdate:{validDate:true,required:true},transaction_edate:{validDate:true,required:true}}});$("#statement-report-form").validate({submitHandler:function(){a()},rules:{statement_date:{validDate:true,required:true}}});$("#income-report-form").validate({submitHandler:function(){k()},rules:{income_bdate:{validDate:true,required:true},income_edate:{validDate:true,required:true}}});$("#account-trail-report-form").validate({submitHandler:function(){j()},rules:{account_trail_date:{validDate:true,required:true}}});$("#account-audit-report-form").validate({submitHandler:function(){e()},rules:{account_audit_bdate:{validDate:true,required:true},account_audit_edate:{validDate:true,required:true}}});$("#lease-report-form").validate({submitHandler:function(){b()},rules:{lease_date:{validDate:true,required:true}}});$("#export-report-form").validate({submitHandler:function(){h()}})});